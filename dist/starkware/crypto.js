"use strict";

/////////////////////////////////////////////////////////////////////////////////
// Copyright 2019 StarkWare Industries Ltd.                                    //
//                                                                             //
// Licensed under the Apache License, Version 2.0 (the "License").             //
// You may not use this file except in compliance with the License.            //
// You may obtain a copy of the License at                                     //
//                                                                             //
// https://www.starkware.co/open-source-license/                               //
//                                                                             //
// Unless required by applicable law or agreed to in writing,                  //
// software distributed under the License is distributed on an "AS IS" BASIS,  //
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.    //
// See the License for the specific language governing permissions             //
// and limitations under the License.                                          //
/////////////////////////////////////////////////////////////////////////////////
var path = require('path');

var BN = require('bn.js');

var BigIntBuffer = require('bigint-buffer');

var assert = require('assert');

var useCryptoCpp = Boolean(process.env.USE_STARKWARE_CRYPTO_CPP);
var libcrypto; // Only load FFI bindings if we run in a Node environment and we asked for it

if (useCryptoCpp) {
  // eslint-disable-next-line
  var ffi = require('ffi-napi'); // Native crypto bindings.


  libcrypto = ffi.Library(path.join(__dirname, '..', '..', 'build', 'Release', 'crypto'), {
    Hash: ['int', ['string', 'string', 'string']],
    Verify: ['bool', ['string', 'string', 'string', 'string']],
    Sign: ['int', ['string', 'string', 'string', 'string']],
    GetPublicKey: ['int', ['string', 'string']]
  });
}

var curveOrder = new BN('800000000000010ffffffffffffffffb781126dcae7b2321e66a241adc64d2f', 16);
/*
 Computes the StarkWare version of the Pedersen hash of x and y.
 Full specification of the hash function can be found here:
 https://docs.starkware.co/starkex-docs/crypto/pedersen-hash-function
*/

function pedersen(x, y) {
  var x_buf = BigIntBuffer.toBufferLE(x, 32);
  var y_buf = BigIntBuffer.toBufferLE(y, 32);
  var res_buf = Buffer.alloc(1024);
  var res = libcrypto.Hash(x_buf, y_buf, res_buf);
  assert.strict(res == 0, 'Error: ' + res_buf.toString('utf-8'));
  return BigIntBuffer.toBigIntLE(res_buf);
}
/*
 Verifies ECDSA signature of a given message hash z with a given public key.
 Returns true if public_key signs the message.
 NOTE: This function assumes that the public_key is on the curve.
*/


function verify(stark_key, message_hash, r, s) {
  var stark_key_buf = BigIntBuffer.toBufferLE(stark_key, 32);
  var message_hash_buf = BigIntBuffer.toBufferLE(message_hash, 32);
  var r_buf = BigIntBuffer.toBufferLE(r, 32);
  var bnS = new BN(s.toString(16), 16);
  var w = BigInt('0x' + bnS.invm(curveOrder).toString(16), 16);
  var s_buf = BigIntBuffer.toBufferLE(w, 32);
  return libcrypto.Verify(stark_key_buf, message_hash_buf, r_buf, s_buf);
}
/*
 Signs the given message hash with the provided private_key, with randomness k.

 NOTE: k should be a strong cryptographical random, and not repeat.
 See: https://tools.ietf.org/html/rfc6979.
*/


function sign(private_key, message, k) {
  var private_key_buf = BigIntBuffer.toBufferLE(private_key, 32);
  var message_buf = BigIntBuffer.toBufferLE(message, 32);
  var k_buf = BigIntBuffer.toBufferLE(k, 32);
  var res_buf = Buffer.alloc(1024);
  var res = libcrypto.Sign(private_key_buf, message_buf, k_buf, res_buf);
  assert.strict(res == 0, 'Error: ' + res_buf.toString('utf-8'));
  var r = BigIntBuffer.toBigIntLE(res_buf.slice(0, 32));
  var w = BigIntBuffer.toBigIntLE(res_buf.slice(32, 64));
  var bnW = new BN(w.toString(16), 16);
  var s = BigInt('0x' + bnW.invm(curveOrder).toString(16), 16);
  return {
    r: r,
    s: s
  };
}
/*
 Deduces the public key given a private key.
 The x coordinate of the public key is also known as the partial public key,
 and used in StarkEx to identify the user.
*/


function getPublicKey(private_key) {
  var private_key_buf = BigIntBuffer.toBufferLE(private_key, 32);
  var res_buf = Buffer.alloc(1024);
  var res = libcrypto.GetPublicKey(private_key_buf, res_buf);
  assert.strict(res == 0, 'Error: ' + res_buf.toString('utf-8'));
  return BigIntBuffer.toBigIntLE(res_buf);
}

module.exports = {
  pedersen: pedersen,
  sign: sign,
  verify: verify,
  getPublicKey: getPublicKey,
  useCryptoCpp: useCryptoCpp
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdGFya3dhcmUvY3J5cHRvLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwiQk4iLCJCaWdJbnRCdWZmZXIiLCJhc3NlcnQiLCJ1c2VDcnlwdG9DcHAiLCJCb29sZWFuIiwicHJvY2VzcyIsImVudiIsIlVTRV9TVEFSS1dBUkVfQ1JZUFRPX0NQUCIsImxpYmNyeXB0byIsImZmaSIsIkxpYnJhcnkiLCJqb2luIiwiX19kaXJuYW1lIiwiSGFzaCIsIlZlcmlmeSIsIlNpZ24iLCJHZXRQdWJsaWNLZXkiLCJjdXJ2ZU9yZGVyIiwicGVkZXJzZW4iLCJ4IiwieSIsInhfYnVmIiwidG9CdWZmZXJMRSIsInlfYnVmIiwicmVzX2J1ZiIsIkJ1ZmZlciIsImFsbG9jIiwicmVzIiwic3RyaWN0IiwidG9TdHJpbmciLCJ0b0JpZ0ludExFIiwidmVyaWZ5Iiwic3Rhcmtfa2V5IiwibWVzc2FnZV9oYXNoIiwiciIsInMiLCJzdGFya19rZXlfYnVmIiwibWVzc2FnZV9oYXNoX2J1ZiIsInJfYnVmIiwiYm5TIiwidyIsIkJpZ0ludCIsImludm0iLCJzX2J1ZiIsInNpZ24iLCJwcml2YXRlX2tleSIsIm1lc3NhZ2UiLCJrIiwicHJpdmF0ZV9rZXlfYnVmIiwibWVzc2FnZV9idWYiLCJrX2J1ZiIsInNsaWNlIiwiYm5XIiwiZ2V0UHVibGljS2V5IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFFQSxJQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLElBQU1DLEVBQUUsR0FBR0QsT0FBTyxDQUFDLE9BQUQsQ0FBbEI7O0FBQ0EsSUFBTUUsWUFBWSxHQUFHRixPQUFPLENBQUMsZUFBRCxDQUE1Qjs7QUFDQSxJQUFNRyxNQUFNLEdBQUdILE9BQU8sQ0FBQyxRQUFELENBQXRC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Ly8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb3B5cmlnaHQgMjAxOSBTdGFya1dhcmUgSW5kdXN0cmllcyBMdGQuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9cbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1xuLy8gTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS4gICAgICAgICAgICAgLy9cbi8vIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gICAgICAgICAgICAvL1xuLy8gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9cbi8vIGh0dHBzOi8vd3d3LnN0YXJrd2FyZS5jby9vcGVuLXNvdXJjZS1saWNlbnNlLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1xuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsICAgICAgICAgICAgICAgICAgLy9cbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUywgIC8vXG4vLyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gICAgLy9cbi8vIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyAgICAgICAgICAgICAvL1xuLy8gYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IEJOID0gcmVxdWlyZSgnYm4uanMnKTtcbmNvbnN0IEJpZ0ludEJ1ZmZlciA9IHJlcXVpcmUoJ2JpZ2ludC1idWZmZXInKTtcbmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ2Fzc2VydCcpO1xuXG5jb25zdCB1c2VDcnlwdG9DcHAgPSBCb29sZWFuKHByb2Nlc3MuZW52LlVTRV9TVEFSS1dBUkVfQ1JZUFRPX0NQUCk7XG5sZXQgbGliY3J5cHRvO1xuXG4vLyBPbmx5IGxvYWQgRkZJIGJpbmRpbmdzIGlmIHdlIHJ1biBpbiBhIE5vZGUgZW52aXJvbm1lbnQgYW5kIHdlIGFza2VkIGZvciBpdFxuaWYgKHVzZUNyeXB0b0NwcCkge1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmVcbiAgY29uc3QgZmZpID0gcmVxdWlyZSgnZmZpLW5hcGknKTtcblxuICAvLyBOYXRpdmUgY3J5cHRvIGJpbmRpbmdzLlxuICBsaWJjcnlwdG8gPSBmZmkuTGlicmFyeShcbiAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnYnVpbGQnLCAnUmVsZWFzZScsICdjcnlwdG8nKSxcbiAgICB7XG4gICAgICBIYXNoOiBbJ2ludCcsIFsnc3RyaW5nJywgJ3N0cmluZycsICdzdHJpbmcnXV0sXG4gICAgICBWZXJpZnk6IFsnYm9vbCcsIFsnc3RyaW5nJywgJ3N0cmluZycsICdzdHJpbmcnLCAnc3RyaW5nJ11dLFxuICAgICAgU2lnbjogWydpbnQnLCBbJ3N0cmluZycsICdzdHJpbmcnLCAnc3RyaW5nJywgJ3N0cmluZyddXSxcbiAgICAgIEdldFB1YmxpY0tleTogWydpbnQnLCBbJ3N0cmluZycsICdzdHJpbmcnXV0sXG4gICAgfVxuICApO1xufVxuXG5jb25zdCBjdXJ2ZU9yZGVyID0gbmV3IEJOKFxuICAnODAwMDAwMDAwMDAwMDEwZmZmZmZmZmZmZmZmZmZmZmI3ODExMjZkY2FlN2IyMzIxZTY2YTI0MWFkYzY0ZDJmJyxcbiAgMTZcbik7XG5cbi8qXG4gQ29tcHV0ZXMgdGhlIFN0YXJrV2FyZSB2ZXJzaW9uIG9mIHRoZSBQZWRlcnNlbiBoYXNoIG9mIHggYW5kIHkuXG4gRnVsbCBzcGVjaWZpY2F0aW9uIG9mIHRoZSBoYXNoIGZ1bmN0aW9uIGNhbiBiZSBmb3VuZCBoZXJlOlxuIGh0dHBzOi8vZG9jcy5zdGFya3dhcmUuY28vc3RhcmtleC1kb2NzL2NyeXB0by9wZWRlcnNlbi1oYXNoLWZ1bmN0aW9uXG4qL1xuZnVuY3Rpb24gcGVkZXJzZW4oeCwgeSkge1xuICBjb25zdCB4X2J1ZiA9IEJpZ0ludEJ1ZmZlci50b0J1ZmZlckxFKHgsIDMyKTtcbiAgY29uc3QgeV9idWYgPSBCaWdJbnRCdWZmZXIudG9CdWZmZXJMRSh5LCAzMik7XG4gIGNvbnN0IHJlc19idWYgPSBCdWZmZXIuYWxsb2MoMTAyNCk7XG4gIGNvbnN0IHJlcyA9IGxpYmNyeXB0by5IYXNoKHhfYnVmLCB5X2J1ZiwgcmVzX2J1Zik7XG4gIGFzc2VydC5zdHJpY3QocmVzID09IDAsICdFcnJvcjogJyArIHJlc19idWYudG9TdHJpbmcoJ3V0Zi04JykpO1xuICByZXR1cm4gQmlnSW50QnVmZmVyLnRvQmlnSW50TEUocmVzX2J1Zik7XG59XG5cbi8qXG4gVmVyaWZpZXMgRUNEU0Egc2lnbmF0dXJlIG9mIGEgZ2l2ZW4gbWVzc2FnZSBoYXNoIHogd2l0aCBhIGdpdmVuIHB1YmxpYyBrZXkuXG4gUmV0dXJucyB0cnVlIGlmIHB1YmxpY19rZXkgc2lnbnMgdGhlIG1lc3NhZ2UuXG4gTk9URTogVGhpcyBmdW5jdGlvbiBhc3N1bWVzIHRoYXQgdGhlIHB1YmxpY19rZXkgaXMgb24gdGhlIGN1cnZlLlxuKi9cbmZ1bmN0aW9uIHZlcmlmeShzdGFya19rZXksIG1lc3NhZ2VfaGFzaCwgciwgcykge1xuICBjb25zdCBzdGFya19rZXlfYnVmID0gQmlnSW50QnVmZmVyLnRvQnVmZmVyTEUoc3Rhcmtfa2V5LCAzMik7XG4gIGNvbnN0IG1lc3NhZ2VfaGFzaF9idWYgPSBCaWdJbnRCdWZmZXIudG9CdWZmZXJMRShtZXNzYWdlX2hhc2gsIDMyKTtcbiAgY29uc3Qgcl9idWYgPSBCaWdJbnRCdWZmZXIudG9CdWZmZXJMRShyLCAzMik7XG4gIGNvbnN0IGJuUyA9IG5ldyBCTihzLnRvU3RyaW5nKDE2KSwgMTYpO1xuICBjb25zdCB3ID0gQmlnSW50KCcweCcgKyBiblMuaW52bShjdXJ2ZU9yZGVyKS50b1N0cmluZygxNiksIDE2KTtcbiAgY29uc3Qgc19idWYgPSBCaWdJbnRCdWZmZXIudG9CdWZmZXJMRSh3LCAzMik7XG4gIHJldHVybiBsaWJjcnlwdG8uVmVyaWZ5KHN0YXJrX2tleV9idWYsIG1lc3NhZ2VfaGFzaF9idWYsIHJfYnVmLCBzX2J1Zik7XG59XG5cbi8qXG4gU2lnbnMgdGhlIGdpdmVuIG1lc3NhZ2UgaGFzaCB3aXRoIHRoZSBwcm92aWRlZCBwcml2YXRlX2tleSwgd2l0aCByYW5kb21uZXNzIGsuXG5cbiBOT1RFOiBrIHNob3VsZCBiZSBhIHN0cm9uZyBjcnlwdG9ncmFwaGljYWwgcmFuZG9tLCBhbmQgbm90IHJlcGVhdC5cbiBTZWU6IGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmM2OTc5LlxuKi9cbmZ1bmN0aW9uIHNpZ24ocHJpdmF0ZV9rZXksIG1lc3NhZ2UsIGspIHtcbiAgY29uc3QgcHJpdmF0ZV9rZXlfYnVmID0gQmlnSW50QnVmZmVyLnRvQnVmZmVyTEUocHJpdmF0ZV9rZXksIDMyKTtcbiAgY29uc3QgbWVzc2FnZV9idWYgPSBCaWdJbnRCdWZmZXIudG9CdWZmZXJMRShtZXNzYWdlLCAzMik7XG4gIGNvbnN0IGtfYnVmID0gQmlnSW50QnVmZmVyLnRvQnVmZmVyTEUoaywgMzIpO1xuICBjb25zdCByZXNfYnVmID0gQnVmZmVyLmFsbG9jKDEwMjQpO1xuICBjb25zdCByZXMgPSBsaWJjcnlwdG8uU2lnbihwcml2YXRlX2tleV9idWYsIG1lc3NhZ2VfYnVmLCBrX2J1ZiwgcmVzX2J1Zik7XG4gIGFzc2VydC5zdHJpY3QocmVzID09IDAsICdFcnJvcjogJyArIHJlc19idWYudG9TdHJpbmcoJ3V0Zi04JykpO1xuICBjb25zdCByID0gQmlnSW50QnVmZmVyLnRvQmlnSW50TEUocmVzX2J1Zi5zbGljZSgwLCAzMikpO1xuICBjb25zdCB3ID0gQmlnSW50QnVmZmVyLnRvQmlnSW50TEUocmVzX2J1Zi5zbGljZSgzMiwgNjQpKTtcbiAgY29uc3QgYm5XID0gbmV3IEJOKHcudG9TdHJpbmcoMTYpLCAxNik7XG4gIGNvbnN0IHMgPSBCaWdJbnQoJzB4JyArIGJuVy5pbnZtKGN1cnZlT3JkZXIpLnRvU3RyaW5nKDE2KSwgMTYpO1xuICByZXR1cm4geyByOiByLCBzOiBzIH07XG59XG5cbi8qXG4gRGVkdWNlcyB0aGUgcHVibGljIGtleSBnaXZlbiBhIHByaXZhdGUga2V5LlxuIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHB1YmxpYyBrZXkgaXMgYWxzbyBrbm93biBhcyB0aGUgcGFydGlhbCBwdWJsaWMga2V5LFxuIGFuZCB1c2VkIGluIFN0YXJrRXggdG8gaWRlbnRpZnkgdGhlIHVzZXIuXG4qL1xuZnVuY3Rpb24gZ2V0UHVibGljS2V5KHByaXZhdGVfa2V5KSB7XG4gIGNvbnN0IHByaXZhdGVfa2V5X2J1ZiA9IEJpZ0ludEJ1ZmZlci50b0J1ZmZlckxFKHByaXZhdGVfa2V5LCAzMik7XG4gIGNvbnN0IHJlc19idWYgPSBCdWZmZXIuYWxsb2MoMTAyNCk7XG4gIGNvbnN0IHJlcyA9IGxpYmNyeXB0by5HZXRQdWJsaWNLZXkocHJpdmF0ZV9rZXlfYnVmLCByZXNfYnVmKTtcbiAgYXNzZXJ0LnN0cmljdChyZXMgPT0gMCwgJ0Vycm9yOiAnICsgcmVzX2J1Zi50b1N0cmluZygndXRmLTgnKSk7XG4gIHJldHVybiBCaWdJbnRCdWZmZXIudG9CaWdJbnRMRShyZXNfYnVmKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIHBlZGVyc2VuLFxuICBzaWduLFxuICB2ZXJpZnksXG4gIGdldFB1YmxpY0tleSxcbiAgdXNlQ3J5cHRvQ3BwLFxufTtcbiJdfQ==