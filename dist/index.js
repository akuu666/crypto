"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
Object.defineProperty(exports, "LimitOrder", {
  enumerable: true,
  get: function get() {
    return _types.LimitOrder;
  }
});
Object.defineProperty(exports, "Signature", {
  enumerable: true,
  get: function get() {
    return _types.Signature;
  }
});
Object.defineProperty(exports, "Transfer", {
  enumerable: true,
  get: function get() {
    return _types.Transfer;
  }
});
exports.verifyTransfer = exports.verifyMessage = exports.verifyLimitOrder = exports.signTransfer = exports.signMessage = exports.signLimitOrder = exports.loadPublicKey = exports.loadPrivateKey = exports.generateKey = exports.exportPublicKeyX = exports.exportPublicKey = exports.exportPrivateKey = void 0;

var _bn = _interopRequireDefault(require("bn.js"));

var _bip = require("bip39");

var _ethereumjsWallet = require("ethereumjs-wallet");

var _hash = _interopRequireDefault(require("hash.js"));

var _keyDerivation = require("./starkware/keyDerivation");

var _signature = require("./starkware/signature");

var _crypto = require("./starkware/crypto");

var _types = require("./types");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var PATH = "m/44'/60'/0'/0/0";

var generateKey = function generateKey(mnemonic) {
  var seed = (0, _bip.mnemonicToSeedSync)(mnemonic || (0, _bip.generateMnemonic)());

  var ethereumAddress = _ethereumjsWallet.hdkey.fromMasterSeed(seed).derivePath(PATH).getWallet().getAddressString();

  var path = (0, _keyDerivation.getAccountPath)('starkex', 'sorare', ethereumAddress, 0);
  return (0, _keyDerivation.getKeyPairFromPath)(mnemonic, path);
};

exports.generateKey = generateKey;

var exportPrivateKey = function exportPrivateKey(key) {
  return "0x".concat(key.getPrivate('hex').padStart(64, '0'));
};

exports.exportPrivateKey = exportPrivateKey;

var exportPublicKey = function exportPublicKey(key) {
  return "0x".concat(key.getPublic(true, 'hex'));
};

exports.exportPublicKey = exportPublicKey;

var exportPublicKeyX = function exportPublicKeyX(key) {
  return "0x".concat(key // force line-break (https://github.com/prettier/prettier/issues/3107)
  .getPublic().getX().toString('hex').padStart(64, '0'));
};

exports.exportPublicKeyX = exportPublicKeyX;

var loadPrivateKey = function loadPrivateKey(privateKey) {
  return _signature.starkEc.keyFromPrivate(privateKey.substring(2), 'hex');
};

exports.loadPrivateKey = loadPrivateKey;

var loadPublicKey = function loadPublicKey(publicKey) {
  return _signature.starkEc.keyFromPublic(publicKey.substring(2), 'hex');
};

exports.loadPublicKey = loadPublicKey;

var hashTransfer = function hashTransfer(transfer) {
  var amount = transfer.amount,
      nonce = transfer.nonce,
      senderVaultId = transfer.senderVaultId,
      token = transfer.token,
      receiverVaultId = transfer.receiverVaultId,
      receiverPublicKey = transfer.receiverPublicKey,
      expirationTimestamp = transfer.expirationTimestamp,
      condition = transfer.condition,
      feeInfoUser = transfer.feeInfoUser;
  var args = [amount, nonce, senderVaultId, token, receiverVaultId, receiverPublicKey, expirationTimestamp, condition];
  if (feeInfoUser) return _signature.getTransferMsgHashWithFee.apply(void 0, args.concat([feeInfoUser.tokenId, feeInfoUser.sourceVaultId, feeInfoUser.feeLimit]));
  return _signature.getTransferMsgHash.apply(void 0, args);
};

var hashLimitOrder = function hashLimitOrder(limitOrder) {
  var vaultIdSell = limitOrder.vaultIdSell,
      vaultIdBuy = limitOrder.vaultIdBuy,
      amountSell = limitOrder.amountSell,
      amountBuy = limitOrder.amountBuy,
      tokenSell = limitOrder.tokenSell,
      tokenBuy = limitOrder.tokenBuy,
      nonce = limitOrder.nonce,
      expirationTimestamp = limitOrder.expirationTimestamp,
      feeInfo = limitOrder.feeInfo;
  var args = [vaultIdSell, vaultIdBuy, amountSell, amountBuy, tokenSell, tokenBuy, nonce, expirationTimestamp];
  if (feeInfo) return _signature.getLimitOrderMsgHashWithFee.apply(void 0, args.concat([feeInfo.tokenId, feeInfo.sourceVaultId, feeInfo.feeLimit]));
  return _signature.getLimitOrderMsgHash.apply(void 0, args);
};

var sign = function sign(privateKey, message) {
  var key = loadPrivateKey(privateKey);

  var _starkSign = (0, _signature.sign)(key, message),
      r = _starkSign.r,
      s = _starkSign.s;

  return {
    r: "0x".concat(r.toString(16)),
    s: "0x".concat(s.toString(16))
  };
};

var verify = function verify(publicKey, message, signature) {
  if (_crypto.useCryptoCpp) {
    return (0, _crypto.verify)(BigInt(publicKey), BigInt("0x".concat(message)), BigInt(signature.r), BigInt(signature.s));
  }

  var key = loadPublicKey(publicKey);
  var sig = {
    r: new _bn.default(signature.r.substring(2), 16),
    s: new _bn.default(signature.s.substring(2), 16)
  };
  return (0, _signature.verify)(key, message, sig);
};

var hashMessage = function hashMessage(message) {
  var h = _hash.default.sha256().update(message).digest('hex');

  return (0, _signature.pedersen)([h.substring(0, 32), h.substring(32)]);
};

var signMessage = function signMessage(privateKey, message) {
  return sign(privateKey, hashMessage(message));
};

exports.signMessage = signMessage;

var verifyMessage = function verifyMessage(publicKey, message, signature) {
  return verify(publicKey, hashMessage(message), signature);
};

exports.verifyMessage = verifyMessage;

var signTransfer = function signTransfer(privateKey, transfer) {
  var message = hashTransfer(transfer);
  return sign(privateKey, message);
};

exports.signTransfer = signTransfer;

var verifyTransfer = function verifyTransfer(publicKey, transfer, signature) {
  var message = hashTransfer(transfer);
  return verify(publicKey, message, signature);
};

exports.verifyTransfer = verifyTransfer;

var signLimitOrder = function signLimitOrder(privateKey, limitOrder) {
  var message = hashLimitOrder(limitOrder);
  return sign(privateKey, message);
};

exports.signLimitOrder = signLimitOrder;

var verifyLimitOrder = function verifyLimitOrder(publicKey, limitOrder, signature) {
  var message = hashLimitOrder(limitOrder);
  return verify(publicKey, message, signature);
};

exports.verifyLimitOrder = verifyLimitOrder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC50cyJdLCJuYW1lcyI6WyJQQVRIIiwiZ2VuZXJhdGVLZXkiLCJtbmVtb25pYyIsInNlZWQiLCJldGhlcmV1bUFkZHJlc3MiLCJoZGtleSIsImZyb21NYXN0ZXJTZWVkIiwiZGVyaXZlUGF0aCIsImdldFdhbGxldCIsImdldEFkZHJlc3NTdHJpbmciLCJwYXRoIiwiZXhwb3J0UHJpdmF0ZUtleSIsImtleSIsImdldFByaXZhdGUiLCJwYWRTdGFydCIsImV4cG9ydFB1YmxpY0tleSIsImdldFB1YmxpYyIsImV4cG9ydFB1YmxpY0tleVgiLCJnZXRYIiwidG9TdHJpbmciLCJsb2FkUHJpdmF0ZUtleSIsInByaXZhdGVLZXkiLCJzdGFya0VjIiwia2V5RnJvbVByaXZhdGUiLCJzdWJzdHJpbmciLCJsb2FkUHVibGljS2V5IiwicHVibGljS2V5Iiwia2V5RnJvbVB1YmxpYyIsImhhc2hUcmFuc2ZlciIsInRyYW5zZmVyIiwiYW1vdW50Iiwibm9uY2UiLCJzZW5kZXJWYXVsdElkIiwidG9rZW4iLCJyZWNlaXZlclZhdWx0SWQiLCJyZWNlaXZlclB1YmxpY0tleSIsImV4cGlyYXRpb25UaW1lc3RhbXAiLCJjb25kaXRpb24iLCJmZWVJbmZvVXNlciIsImFyZ3MiLCJnZXRUcmFuc2Zlck1zZ0hhc2hXaXRoRmVlIiwidG9rZW5JZCIsInNvdXJjZVZhdWx0SWQiLCJmZWVMaW1pdCIsImdldFRyYW5zZmVyTXNnSGFzaCIsImhhc2hMaW1pdE9yZGVyIiwibGltaXRPcmRlciIsInZhdWx0SWRTZWxsIiwidmF1bHRJZEJ1eSIsImFtb3VudFNlbGwiLCJhbW91bnRCdXkiLCJ0b2tlblNlbGwiLCJ0b2tlbkJ1eSIsImZlZUluZm8iLCJnZXRMaW1pdE9yZGVyTXNnSGFzaFdpdGhGZWUiLCJnZXRMaW1pdE9yZGVyTXNnSGFzaCIsInNpZ24iLCJtZXNzYWdlIiwiciIsInMiLCJ2ZXJpZnkiLCJzaWduYXR1cmUiLCJ1c2VDcnlwdG9DcHAiLCJCaWdJbnQiLCJzaWciLCJCTiIsImhhc2hNZXNzYWdlIiwiaCIsImhhc2giLCJzaGEyNTYiLCJ1cGRhdGUiLCJkaWdlc3QiLCJzaWduTWVzc2FnZSIsInZlcmlmeU1lc3NhZ2UiLCJzaWduVHJhbnNmZXIiLCJ2ZXJpZnlUcmFuc2ZlciIsInNpZ25MaW1pdE9yZGVyIiwidmVyaWZ5TGltaXRPcmRlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUNBOztBQUdBOztBQUNBOztBQVVBOztBQUVBOzs7O0FBRUEsSUFBTUEsSUFBSSxHQUFHLGtCQUFiOztBQUVPLElBQU1DLFdBQVcsR0FBRyxTQUFkQSxXQUFjLENBQUNDLFFBQUQsRUFBdUI7QUFDaEQsTUFBTUMsSUFBSSxHQUFHLDZCQUFtQkQsUUFBUSxJQUFJLDRCQUEvQixDQUFiOztBQUNBLE1BQU1FLGVBQWUsR0FBR0Msd0JBQ3JCQyxjQURxQixDQUNOSCxJQURNLEVBRXJCSSxVQUZxQixDQUVWUCxJQUZVLEVBR3JCUSxTQUhxQixHQUlyQkMsZ0JBSnFCLEVBQXhCOztBQU1BLE1BQU1DLElBQUksR0FBRyxtQ0FBZSxTQUFmLEVBQTBCLFFBQTFCLEVBQW9DTixlQUFwQyxFQUFxRCxDQUFyRCxDQUFiO0FBQ0EsU0FBTyx1Q0FBbUJGLFFBQW5CLEVBQTZCUSxJQUE3QixDQUFQO0FBQ0QsQ0FWTTs7OztBQVlBLElBQU1DLGdCQUFnQixHQUFHLFNBQW5CQSxnQkFBbUIsQ0FBQ0MsR0FBRDtBQUFBLHFCQUN6QkEsR0FBRyxDQUFDQyxVQUFKLENBQWUsS0FBZixFQUFzQkMsUUFBdEIsQ0FBK0IsRUFBL0IsRUFBbUMsR0FBbkMsQ0FEeUI7QUFBQSxDQUF6Qjs7OztBQUdBLElBQU1DLGVBQWUsR0FBRyxTQUFsQkEsZUFBa0IsQ0FBQ0gsR0FBRDtBQUFBLHFCQUN4QkEsR0FBRyxDQUFDSSxTQUFKLENBQWMsSUFBZCxFQUFvQixLQUFwQixDQUR3QjtBQUFBLENBQXhCOzs7O0FBR0EsSUFBTUMsZ0JBQWdCLEdBQUcsU0FBbkJB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QyxTQUFELEVBQVkrQixPQUFaLEVBQXFCSSxTQUFyQixDQUFiO0FBQ0QsQ0FSTTs7OztBQVVBLElBQU1lLGNBQWMsR0FBRyxTQUFqQkEsY0FBaUIsQ0FDNUJ2RCxVQUQ0QixFQUU1QnlCLFVBRjRCLEVBR2Q7QUFDZCxNQUFNVyxPQUFPLEdBQUdaLGNBQWMsQ0FBQ0MsVUFBRCxDQUE5QjtBQUVBLFNBQU9VLElBQUksQ0FBQ25DLFVBQUQsRUFBYW9DLE9BQWIsQ0FBWDtBQUNELENBUE07Ozs7QUFTQSxJQUFNb0IsZ0JBQWdCLEdBQUcsU0FBbkJBLGdCQUFtQixDQUM5Qm5ELFNBRDhCLEVBRTlCb0IsVUFGOEIsRUFHOUJlLFNBSDhCLEVBSWxCO0FBQ1osTUFBTUosT0FBTyxHQUFHWixjQUFjLENBQUNDLFVBQUQsQ0FBOUI7QUFFQSxTQUFPYyxNQUFNLENBQUNsQyxTQUFELEVBQVkrQixPQUFaLEVBQXFCSSxTQUFyQixDQUFiO0FBQ0QsQ0FSTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCTiBmcm9tICdibi5qcyc7XG5pbXBvcnQgeyBnZW5lcmF0ZU1uZW1vbmljLCBtbmVtb25pY1RvU2VlZFN5bmMgfSBmcm9tICdiaXAzOSc7XG5pbXBvcnQgeyBlYyB9IGZyb20gJ2VsbGlwdGljJztcbmltcG9ydCB7IGhka2V5IH0gZnJvbSAnZXRoZXJldW1qcy13YWxsZXQnO1xuaW1wb3J0IGhhc2ggZnJvbSAnaGFzaC5qcyc7XG5cbmltcG9ydCB7IExpbWl0T3JkZXIsIFRyYW5zZmVyLCBTaWduYXR1cmUgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IGdldEFjY291bnRQYXRoLCBnZXRLZXlQYWlyRnJvbVBhdGggfSBmcm9tICcuL3N0YXJrd2FyZS9rZXlEZXJpdmF0aW9uJztcbmltcG9ydCB7XG4gIHN0YXJrRWMsXG4gIHBlZGVyc2VuLFxuICBzaWduIGFzIHN0YXJrU2lnbixcbiAgdmVyaWZ5IGFzIHN0YXJrVmVyaWZ5LFxuICBnZXRUcmFuc2Zlck1zZ0hhc2gsXG4gIGdldFRyYW5zZmVyTXNnSGFzaFdpdGhGZWUsXG4gIGdldExpbWl0T3JkZXJNc2dIYXNoLFxuICBnZXRMaW1pdE9yZGVyTXNnSGFzaFdpdGhGZWUsXG59IGZyb20gJy4vc3Rhcmt3YXJlL3NpZ25hdHVyZSc7XG5pbXBvcnQgeyB2ZXJpZnkgYXMgc3RhcmtWZXJpZnlDcHAsIHVzZUNyeXB0b0NwcCB9IGZyb20gJy4vc3Rhcmt3YXJlL2NyeXB0byc7XG5cbmV4cG9ydCB7IExpbWl0T3JkZXIsIFRyYW5zZmVyLCBTaWduYXR1cmUgfSBmcm9tICcuL3R5cGVzJztcblxuY29uc3QgUEFUSCA9IFwibS80NCcvNjAnLzAnLzAvMFwiO1xuXG5leHBvcnQgY29uc3QgZ2VuZXJhdGVLZXkgPSAobW5lbW9uaWM/OiBzdHJpbmcpID0+IHtcbiAgY29uc3Qgc2VlZCA9IG1uZW1vbmljVG9TZWVkU3luYyhtbmVtb25pYyB8fCBnZW5lcmF0ZU1uZW1vbmljKCkpO1xuICBjb25zdCBldGhlcmV1bUFkZHJlc3MgPSBoZGtleVxuICAgIC5mcm9tTWFzdGVyU2VlZChzZWVkKVxuICAgIC5kZXJpdmVQYXRoKFBBVEgpXG4gICAgLmdldFdhbGxldCgpXG4gICAgLmdldEFkZHJlc3NTdHJpbmcoKTtcblxuICBjb25zdCBwYXRoID0gZ2V0QWNjb3VudFBhdGgoJ3N0YXJrZXgnLCAnc29yYXJlJywgZXRoZXJldW1BZGRyZXNzLCAwKTtcbiAgcmV0dXJuIGdldEtleVBhaXJGcm9tUGF0aChtbmVtb25pYywgcGF0aCk7XG59O1xuXG5leHBvcnQgY29uc3QgZXhwb3J0UHJpdmF0ZUtleSA9IChrZXk6IGVjLktleVBhaXIpID0+XG4gIGAweCR7a2V5LmdldFByaXZhdGUoJ2hleCcpLnBhZFN0YXJ0KDY0LCAnMCcpfWA7XG5cbmV4cG9ydCBjb25zdCBleHBvcnRQdWJsaWNLZXkgPSAoa2V5OiBlYy5LZXlQYWlyKSA9PlxuICBgMHgke2tleS5nZXRQdWJsaWModHJ1ZSwgJ2hleCcpfWA7XG5cbmV4cG9ydCBjb25zdCBleHBvcnRQdWJsaWNLZXlYID0gKGtleTogZWMuS2V5UGFpcikgPT5cbiAgYDB4JHtrZXkgLy8gZm9yY2UgbGluZS1icmVhayAoaHR0cHM6Ly9naXRodWIuY29tL3ByZXR0aWVyL3ByZXR0aWVyL2lzc3Vlcy8zMTA3KVxuICAgIC5nZXRQdWJsaWMoKVxuICAgIC5nZXRYKClcbiAgICAudG9TdHJpbmcoJ2hleCcpXG4gICAgLnBhZFN0YXJ0KDY0LCAnMCcpfWA7XG5cbmV4cG9ydCBjb25zdCBsb2FkUHJpdmF0ZUtleSA9IChwcml2YXRlS2V5OiBzdHJpbmcpID0+XG4gIHN0YXJrRWMua2V5RnJvbVByaXZhdGUocHJpdmF0ZUtleS5zdWJzdHJpbmcoMiksICdoZXgnKTtcblxuZXhwb3J0IGNvbnN0IGxvYWRQdWJsaWNLZXkgPSAocHVibGljS2V5OiBzdHJpbmcpID0+XG4gIHN0YXJrRWMua2V5RnJvbVB1YmxpYyhwdWJsaWNLZXkuc3Vic3RyaW5nKDIpLCAnaGV4Jyk7XG5cbmNvbnN0IGhhc2hUcmFuc2ZlciA9ICh0cmFuc2ZlcjogVHJhbnNmZXIpID0+IHtcbiAgY29uc3Qge1xuICAgIGFtb3VudCxcbiAgICBub25jZSxcbiAgICBzZW5kZXJWYXVsdElkLFxuICAgIHRva2VuLFxuICAgIHJlY2VpdmVyVmF1bHRJZCxcbiAgICByZWNlaXZlclB1YmxpY0tleSxcbiAgICBleHBpcmF0aW9uVGltZXN0YW1wLFxuICAgIGNvbmRpdGlvbixcbiAgICBmZWVJbmZvVXNlcixcbiAgfSA9IHRyYW5zZmVyO1xuXG4gIGNvbnN0IGFyZ3MgPSBbXG4gICAgYW1vdW50LFxuICAgIG5vbmNlLFxuICAgIHNlbmRlclZhdWx0SWQsXG4gICAgdG9rZW4sXG4gICAgcmVjZWl2ZXJWYXVsdElkLFxuICAgIHJlY2VpdmVyUHVibGljS2V5LFxuICAgIGV4cGlyYXRpb25UaW1lc3RhbXAsXG4gICAgY29uZGl0aW9uLFxuICBdO1xuXG4gIGlmIChmZWVJbmZvVXNlcilcbiAgICByZXR1cm4gZ2V0VHJhbnNmZXJNc2dIYXNoV2l0aEZlZShcbiAgICAgIC4uLmFyZ3MsXG4gICAgICBmZWVJbmZvVXNlci50b2tlbklkLFxuICAgICAgZmVlSW5mb1VzZXIuc291cmNlVmF1bHRJZCxcbiAgICAgIGZlZUluZm9Vc2VyLmZlZUxpbWl0XG4gICAgKTtcblxuICByZXR1cm4gZ2V0VHJhbnNmZXJNc2dIYXNoKC4uLmFyZ3MpO1xufTtcblxuY29uc3QgaGFzaExpbWl0T3JkZXIgPSAobGltaXRPcmRlcjogTGltaXRPcmRlcikgPT4ge1xuICBjb25zdCB7XG4gICAgdmF1bHRJZFNlbGwsXG4gICAgdmF1bHRJZEJ1eSxcbiAgICBhbW91bnRTZWxsLFxuICAgIGFtb3VudEJ1eSxcbiAgICB0b2tlblNlbGwsXG4gICAgdG9rZW5CdXksXG4gICAgbm9uY2UsXG4gICAgZXhwaXJhdGlvblRpbWVzdGFtcCxcbiAgICBmZWVJbmZvLFxuICB9ID0gbGltaXRPcmRlcjtcblxuICBjb25zdCBhcmdzID0gW1xuICAgIHZhdWx0SWRTZWxsLFxuICAgIHZhdWx0SWRCdXksXG4gICAgYW1vdW50U2VsbCxcbiAgICBhbW91bnRCdXksXG4gICAgdG9rZW5TZWxsLFxuICAgIHRva2VuQnV5LFxuICAgIG5vbmNlLFxuICAgIGV4cGlyYXRpb25UaW1lc3RhbXAsXG4gIF07XG5cbiAgaWYgKGZlZUluZm8pXG4gICAgcmV0dXJuIGdldExpbWl0T3JkZXJNc2dIYXNoV2l0aEZlZShcbiAgICAgIC4uLmFyZ3MsXG4gICAgICBmZWVJbmZvLnRva2VuSWQsXG4gICAgICBmZWVJbmZvLnNvdXJjZVZhdWx0SWQsXG4gICAgICBmZWVJbmZvLmZlZUxpbWl0XG4gICAgKTtcblxuICByZXR1cm4gZ2V0TGltaXRPcmRlck1zZ0hhc2goLi4uYXJncyk7XG59O1xuXG5jb25zdCBzaWduID0gKHByaXZhdGVLZXk6IHN0cmluZywgbWVzc2FnZTogc3RyaW5nKTogU2lnbmF0dXJlID0+IHtcbiAgY29uc3Qga2V5ID0gbG9hZFByaXZhdGVLZXkocHJpdmF0ZUtleSk7XG4gIGNvbnN0IHsgciwgcyB9ID0gc3RhcmtTaWduKGtleSwgbWVzc2FnZSk7XG5cbiAgcmV0dXJuIHtcbiAgICByOiBgMHgke3IudG9TdHJpbmcoMTYpfWAsXG4gICAgczogYDB4JHtzLnRvU3RyaW5nKDE2KX1gLFxuICB9O1xufTtcblxuY29uc3QgdmVyaWZ5ID0gKHB1YmxpY0tleTogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcsIHNpZ25hdHVyZTogU2lnbmF0dXJlKSA9PiB7XG4gIGlmICh1c2VDcnlwdG9DcHApIHtcbiAgICByZXR1cm4gc3RhcmtWZXJpZnlDcHAoXG4gICAgICBCaWdJbnQocHVibGljS2V5KSxcbiAgICAgIEJpZ0ludChgMHgke21lc3NhZ2V9YCksXG4gICAgICBCaWdJbnQoc2lnbmF0dXJlLnIpLFxuICAgICAgQmlnSW50KHNpZ25hdHVyZS5zKVxuICAgICk7XG4gIH1cblxuICBjb25zdCBrZXkgPSBsb2FkUHVibGljS2V5KHB1YmxpY0tleSk7XG4gIGNvbnN0IHNpZyA9IHtcbiAgICByOiBuZXcgQk4oc2lnbmF0dXJlLnIuc3Vic3RyaW5nKDIpLCAxNiksXG4gICAgczogbmV3IEJOKHNpZ25hdHVyZS5zLnN1YnN0cmluZygyKSwgMTYpLFxuICB9O1xuXG4gIHJldHVybiBzdGFya1ZlcmlmeShrZXksIG1lc3NhZ2UsIHNpZyk7XG59O1xuXG5jb25zdCBoYXNoTWVzc2FnZSA9IChtZXNzYWdlOiBzdHJpbmcpID0+IHtcbiAgY29uc3QgaCA9IGhhc2guc2hhMjU2KCkudXBkYXRlKG1lc3NhZ2UpLmRpZ2VzdCgnaGV4Jyk7XG4gIHJldHVybiBwZWRlcnNlbihbaC5zdWJzdHJpbmcoMCwgMzIpLCBoLnN1YnN0cmluZygzMildKTtcbn07XG5cbmV4cG9ydCBjb25zdCBzaWduTWVzc2FnZSA9IChwcml2YXRlS2V5OiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZyk6IFNpZ25hdHVyZSA9PlxuICBzaWduKHByaXZhdGVLZXksIGhhc2hNZXNzYWdlKG1lc3NhZ2UpKTtcblxuZXhwb3J0IGNvbnN0IHZlcmlmeU1lc3NhZ2UgPSAoXG4gIHB1YmxpY0tleTogc3RyaW5nLFxuICBtZXNzYWdlOiBzdHJpbmcsXG4gIHNpZ25hdHVyZTogU2lnbmF0dXJlXG4pID0+IHZlcmlmeShwdWJsaWNLZXksIGhhc2hNZXNzYWdlKG1lc3NhZ2UpLCBzaWduYXR1cmUpO1xuXG5leHBvcnQgY29uc3Qgc2lnblRyYW5zZmVyID0gKFxuICBwcml2YXRlS2V5OiBzdHJpbmcsXG4gIHRyYW5zZmVyOiBUcmFuc2ZlclxuKTogU2lnbmF0dXJlID0+IHtcbiAgY29uc3QgbWVzc2FnZSA9IGhhc2hUcmFuc2Zlcih0cmFuc2Zlcik7XG5cbiAgcmV0dXJuIHNpZ24ocHJpdmF0ZUtleSwgbWVzc2FnZSk7XG59O1xuXG5leHBvcnQgY29uc3QgdmVyaWZ5VHJhbnNmZXIgPSAoXG4gIHB1YmxpY0tleTogc3RyaW5nLFxuICB0cmFuc2ZlcjogVHJhbnNmZXIsXG4gIHNpZ25hdHVyZTogU2lnbmF0dXJlXG4pOiBib29sZWFuID0+IHtcbiAgY29uc3QgbWVzc2FnZSA9IGhhc2hUcmFuc2Zlcih0cmFuc2Zlcik7XG5cbiAgcmV0dXJuIHZlcmlmeShwdWJsaWNLZXksIG1lc3NhZ2UsIHNpZ25hdHVyZSk7XG59O1xuXG5leHBvcnQgY29uc3Qgc2lnbkxpbWl0T3JkZXIgPSAoXG4gIHByaXZhdGVLZXk6IHN0cmluZyxcbiAgbGltaXRPcmRlcjogTGltaXRPcmRlclxuKTogU2lnbmF0dXJlID0+IHtcbiAgY29uc3QgbWVzc2FnZSA9IGhhc2hMaW1pdE9yZGVyKGxpbWl0T3JkZXIpO1xuXG4gIHJldHVybiBzaWduKHByaXZhdGVLZXksIG1lc3NhZ2UpO1xufTtcblxuZXhwb3J0IGNvbnN0IHZlcmlmeUxpbWl0T3JkZXIgPSAoXG4gIHB1YmxpY0tleTogc3RyaW5nLFxuICBsaW1pdE9yZGVyOiBMaW1pdE9yZGVyLFxuICBzaWduYXR1cmU6IFNpZ25hdHVyZVxuKTogYm9vbGVhbiA9PiB7XG4gIGNvbnN0IG1lc3NhZ2UgPSBoYXNoTGltaXRPcmRlcihsaW1pdE9yZGVyKTtcblxuICByZXR1cm4gdmVyaWZ5KHB1YmxpY0tleSwgbWVzc2FnZSwgc2lnbmF0dXJlKTtcbn07XG4iXX0=